# 物理碰撞测试指南

## 问题描述
SchoolBuilding.ts 的物理碰撞效果无法被 Model.ts 人物使用，BVH辅助线不显示。

## 修复内容

### 1. SchoolBuilding.ts 关键修复
- **BVH创建修复**: 修正了BVH创建流程，确保几何体正确处理
- **物理体位置修复**: 由于StaticGeometryGenerator已应用变换，物理体和碰撞体都设置在原点
- **可视化修复**: 默认开启所有可视化辅助线，修复BVH辅助线不显示问题
- **材质兼容性**: 统一了摩擦力(0.5)和弹性系数(0.3)，与 Model.ts 保持一致
- **Trimesh 优化**: 限制顶点数量避免性能问题，大模型自动使用ConvexPolyhedron

### 2. Model.ts 关键修复 ⭐
- **移动逻辑修复**: 修复了直接修改mesh.position覆盖物理引擎结果的问题
- **物理引擎优先**: 让物理引擎控制位置，而不是直接移动模型
- **速度控制**: 通过设置物理体速度来控制移动，而不是直接修改位置
- **同步改进**: 改进了物理体到模型的位置同步逻辑

### 3. 物理交互修复
- **持续同步**: 确保物理体位置持续同步，不仅仅在移动时
- **碰撞响应**: 让物理引擎处理碰撞响应，模型位置由物理引擎控制
- **调试增强**: 添加了物理同步状态检查和碰撞测试功能

## 测试步骤

### 1. 启动应用
```bash
npm run dev
```

### 2. 打开浏览器控制台
查看物理体创建和验证的日志信息。

### 3. 使用调试按钮
- 点击"检查碰撞状态"按钮
- 点击"显示物理信息"按钮

### 4. 测试人物移动
- 使用 WASD 键移动人物
- 观察人物是否能与建筑物发生碰撞
- 检查控制台是否有碰撞事件日志

## 预期结果

### 控制台输出应该显示:
```
🏫 SchoolBuilding 构造函数调用完成
🔍 物理世界状态: ✅ 已传递
📁 开始加载学校建筑模型文件...
✅ 学校建筑模型文件加载成功
🔧 开始创建BVH和可视化辅助线...
✅ BVH创建成功
✅ 碰撞体网格创建完成
✅ BVH可视化辅助线创建完成
✅ 碰撞体已添加到场景
✅ BVH可视化器已添加到场景
✅ 学校建筑CANNON物理体已创建并添加到物理世界
✅ 学校建筑物理体验证成功，可以与人物进行碰撞检测
✅ 人物物理体验证成功，可以与建筑物进行碰撞检测
```

### 人物移动时:
- 人物应该无法穿透建筑物
- 碰撞时应该有推力反馈
- 控制台应该显示碰撞事件信息

## 故障排除

### 如果碰撞仍然无效:
1. 检查物理体是否在同一个物理世界中
2. 检查物理体位置是否正确
3. 检查材质参数是否兼容
4. 检查物理引擎更新时序

### 常见问题:
- **物理体位置错误**: 确保建筑物的世界变换正确应用到物理体
- **材质不兼容**: 确保摩擦力和弹性系数设置合理
- **几何体过于复杂**: ConvexPolyhedron 简化可能过度，考虑调整参数
- **时序问题**: 确保物理体在模型完全加载后创建

## 调试命令

在浏览器控制台中可以使用以下命令进行调试:

```javascript
// 检查物理世界状态
physicsManager.showPhysicsInfo()
physicsManager.checkCollisionDetection()

// 检查人物物理体
const model = mmdModelManager.getModel()
model.validatePhysicsBodyInWorld()
model.getPhysicsBodyInfo()

// 检查建筑物理体
const building = objectManager.getObject('school-building')
building.validatePhysicsBodyInWorld()
building.getPhysicsBodyInfo()
```
